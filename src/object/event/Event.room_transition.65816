/**
* Configurable cutscene-style event used for enter_room* and start_* markers.
* Stores the transition id parameter and can optionally trigger its result
* immediately once the timeline opens while still honoring the deadline
* via abstract.Event.checkResult.
*/
.include "src/object/event/Event.room_transition.h"

.section "Event.room_trans"

; transition id is passed as OBJECT.CALL.ARG.5
; optional immediate-branch flag is passed as OBJECT.CALL.ARG.6 (non-zero)

  METHOD init
  rep #$31

  jsr Event.template.initCommon

  lda OBJECT.CALL.ARG.5,s
  sta this.transitionId

  lda OBJECT.CALL.ARG.6,s
  beq +
    lda #1
    bra ++
+   lda #0
++  sta this.branchImmediate
  stz this.hasTriggered

  rts

  METHOD play
  rep #$31

  jsr Event.template.waitTimeline
  bcc +

  lda this.branchImmediate
  beq +
  lda this.hasTriggered
  bne +
    jsr abstract.Event.triggerResult
    lda #1
    sta this.hasTriggered

+ jsr abstract.Event.checkResult

  rts

  METHOD kill
  rep #$31
  lda #OBJR_kill
  sta 3,s
  rts

  CLASS Event.room_transition
.ends
